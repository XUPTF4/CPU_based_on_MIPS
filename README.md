# CPU_based_on_MIPS

这是说一些说明文档。

## 一、“FPGA模型机课程设计”的时间安排可视实际情况而定，主要内容和安排

### 第一周周一

FPGA模型计算机整体方案设计。由指导教师给学生讲解本课程设计的题目和要求。学生自行分组，每组成员不得超过4人，由于设备数量关系，建议每组成员3~4人。学生小组认真研究“FPGA模型机设计”课程网站上题目要求和教学资源，查阅有关资料，确定所设计MIPS指令集范畴，完成模型机整体方案设计，搭建设计所需的软硬件环境，注意分工合作：模型机代码编写测试和FPGA开发板下载使用，逐步推进设计开发实现工作。

### 第一周周二

模型计算机各功能电路设计。学生根据总体方案，自行运用VerilogHDL语言进行运算器设计、存储器设计、输入\输出端口设计、总线接口设计等。即要求完成20条MIPS整数指令，基本能够在Modelsim上进行功能仿真，运算、转移和访存功能需测试正确，能够模型机在FPGA开发板上下载运行简单测试。

### 第一周周三

模型机指令系统设计。学生根据搭建的模型机数据通路图，选择扩展的指令格式和指令功能。扩展指令系统的选择可以参照MIPS 32位处理器指令集，选择MIPS12条整数指令。要求能够画出指令格式和指令功能，能够画出处理器内部实现结构图，包括时序信号和控制信号，可以采用单周期方案，能够在FPGA开发板上运行较为综合程序测试所有指令的功能。

### 第一周周四

选择MIPS与中断异常相关的6条指令，继续将完整模型机的指令进行实现。学生将在Modelsim里仿真验证通过的模型机程序，并编写具体测试指令，能够通过简单的中断异常机器指令对中断异常等功能进行测试，能够Modelsim/Vivoda中仿真上运行中断异常的测试，注意要逐条指令的细致对比分析，并验证功能的正确性。由于中断异常实现与一般程序有较大区别，需仿真验证正确且真正理解掌握其实现方式后，再进行下载FPGA开发板。

### 第一周周五

模型机整体的联调。完成模型机指令系统实现。学生根据设计好的指令系统实现方案，在Modelsim上进行功能仿真。要求将所有设计的机器指令都仿真正确，包括：数据流通、时序节拍、寄存器的读写，输入输出端口的访问、接口控制信号等。所有指令功能测试正确。指导教师对学生进行中期检查，主要观察指令运行结果，包括数据寄存器打入是否正确，转移指令是否正确设置PC，中断异常等指令功能的实现，即能够编写具体测试指令，能够通过简单的中断异常机器指令对中断异常等功能进行测试，能够在FPGA开发板上运行中断异常的测试并验证功能的正确性。注意若本阶段任务达成，需录制视频让指导教师验收，并将调试好的版本freeze冻结，因为下周开始将要进行流水线设计，改动较大。

### 第二周周一

设计指令流水线，按照指令周期不同阶段进行划分，实现指令基本流水处理功能。然后在基本流水线设计基础上加入数据相关、资源相关处理和控制相关的解决，编写机器指令程序，对指令逐一进行测试。注意每添加一个相关冲突解决都需要进行相应的测试，测试务必细致，是考验设计开发者的基本功，务必重视。在Modelsim/Vivado中仿真检测结果时需注意每条指令功能和时序的对应关系。在FPGA开发板上运行相应的测试程序，验证指令流水线的正确性。

### 第二周周二

在数据相关、资源相关处理和控制相关的解决基础上，将中断异常引入流水线，实现精确的中断异常控制。注意中断异常的实现方式，和对流水线的影响。中断异常发时后，是在最后一个阶段收集，并将流水线中所有指令提交申请（写入寄存器或存储器）作废。需正确设计相应的冲突解决方案。然后编写异常中断测试程序，在Modelsim/Vivado里仿真测试，注意对时序和功能进行细致比对分析，确保时序和功能仿真正确。进而编写中断异常的测试程序，对模型机的功能进行实现和仿真验证。

### 第二周周三

编写较为复杂的系统测试程序，将完整模型机的指令进行实现和仿真验证。在Modelsim/Vivado里仿真测试，注意对时序和功能进行细致比对分析，确保时序和功能仿真正确。进而模型机在FPGA上的功能测试。能够用机器指令编写较复杂功能的程序，测试模型机的各项功能。要求：用机器指令编写的程序应在Modelsim上仿真通过，明确实验结果。该测试程序由学生自行设计，需将所设计结果和指令运行结果逐一验证以确保正确。能够通过Vivado将模型机下载FPGA开发板进行验证。该测试程序由学生自行设计，测试指令种类和条数越多，测试功能越多，性能提升明显者为佳。

### 第二周周四

教师检查学生完成情况，每个学生组应诚实地将自己的作品向教师进行展示。，包括功能演示、设计方案讲解、设计步骤讲解、实验结果正确性分析等。教师需根据每个设计组以及每个学生承担的具体工作合理评分。对流水处理器进行改进和完善，注意数据相关和控制相关冲突的解决。编写机器指令程序，对各条指令功能逐一进行检测。教师需根据每个设计组以及每个学生承担的具体工作合理评分。

### 第二周周五：课程设计收尾及优秀作品展示答辩

学生小组在通过验收后，录制模型机演示视频（一般<3min，优秀组可适当延长），优秀设计者需制作答辩讲解ppt。模型机演示视频应包括：所设计的指令集、模型机架构、程序运行演示和对运行结果的说明；曾经出现的问题及解决办法；每位成员在设计开发团队中起到的作用。所录视频为mp4格式，要求屏幕视角大，图像清晰，声音洪亮，演示运行过程清楚明了，运行结果是否正确有解释说明。视频最好有字幕提示。
学生小组整理好FPGA开发板和实验工具，归还硬件实验室。整理好代码和文档，包括模型机整体设计、各模块设计、测试代码说明等。学生撰写FPGA模型机课程设计报告，注意需在其中说明个人的分工和体会。

## 二、关键时间节点和要求

- 1.第一周周一 完成分组并向指导教师报告。
- 2.第一周周五 完成模型机设计所有仿真测试，包括基本20条指令和扩展12条指令，以及6条中断异常指令，包括在FPGA开发板上运行测试。
- 3.第二周周三 基本完成所有设计实现工作，包括流水设计的处理器和FPGA开发板下载运行和验证。
- 4.第二周周四 学生小组完成项目验收，现场操作演示，回答问题。
- 5.第二周周五 课程设计收尾及优秀作品展示答辩。

## 三、实验要求

### 基本模型机：（20%）

实现基本20条MIPS整数指令，模型机在Modelsim上时序和功能仿真正确。编写机器指令程序，实现逐条指令功能测试和复杂功能测试。应用程序由学生自行编写，题材不限。以指令实现越多，功能测试越多者为佳。

### 完整模型机：（30%）

实现全部扩展指令，即包括12条MIPS整数指令和中断相关指令。学生编写机器指令程序，实现逐条指令功能测试和复杂功能测试。该应用程序由学生自行编写，题材不限。以指令实现越多，功能测试越多者为佳。

### 流水处理器（50%）

实现流水处理器，包括之前（表1~表3）所有指令功能，能够合理划分流水阶段，解决数据相关和控制相关冲突,以及实现精确中断异常。通过基本指令测试和复杂功能测试，所有程序功能测试正确，并且效率提升显著者为佳。

## 四、任务要求

1、在Modelsim/Vivado仿真环境下实现模型机系统功能仿真测试。
2、在FPGA开发板上实现模型机系统功能验证实现。
3、验收：视频系统演示、回答教师问题。
4、优秀设计者制作ppt，讲解设计思想，展示设计成果（视频演示），参加答辩
5、每名学生需自行完成课程设计报告。
每个学生小组需提交组内互评表给指导教师。

## 附录

### Table 1: MIPS 20 Integer Instructions

| 指令  | 31:26   | 25:21   | 20:16  | 15:11  | 10:6   | 5:0    | 意义                  |
|-------|---------|---------|--------|--------|--------|--------|-----------------------|
| add   | 000000  | rs      | rt     | rd     | 00000  | 100000 | 寄存器加               |
| sub   | 000000  | rs      | rt     | rd     | 00000  | 100010 | 寄存器减               |
| and   | 000000  | rs      | rt     | rd     | 00000  | 100100 | 寄存器与               |
| or    | 000000  | rs      | rt     | rd     | 00000  | 100101 | 寄存器或               |
| xor   | 000000  | rs      | rt     | rd     | 00000  | 100110 | 寄存器异或             |
| sll   | 000000  | 00000   | rt     | rd     | 00000  | 100000 | 左移                  |
| srl   | 000000  | 00000   | rt     | rd     | sa     | 000010 | 逻辑右移               |
| sra   | 000000  | 00000   | rt     | rd     | sa     | 000011 | 算术右移               |
| jr    | 000000  | rs      | 00000  | 00000  | 00001  | 001000 | 寄存器跳转             |
| addi  | 001000  | rs      | rt     | immediate |        |        | 立即数加               |
| andi  | 001100  | rs      | rt     | immediate |        |        | 立即数与               |
| ori   | 001101  | rs      | rt     | immediate |        |        | 立即数或               |
| xori  | 001110  | rs      | rt     | immediate |        |        | 立即数异或             |
| lw    | 100011  | rs      | rt     | offset    |        |        | 取整数字据             |
| sw    | 101011  | rs      | rt     | offset    |        |        | 存整数字据             |
| beq   | 000100  | rs      | rt     | offset    |        |        | 相等转移               |
| bne   | 000101  | rs      | rt     | offset    |        |        | 不等转移               |
| lui   | 001111  | 00000   | rt     | immediate |        |        | 设置高位               |
| j     | 000010  | address |        |        |        |        | 跳转                   |
| jal   | 000011  | address |        |        |        |        | 调用                   |

### Table 2: MIPS 12 Integer Instructions

| 指令            | 31:26    | 25:21  | 20:16  | 15:11 | 10:6   | 5:0    | 功能                             |
|----------------|----------|--------|--------|-------|--------|--------|----------------------------------|
| slt rd, rs, rt | 000000   | rs     | rt     | Rd    | 00000  | 101010 | rd <- (rs < rt), signed         |
| bgtz rs, offset| 000111   | rs     | 00000  | offset|        |        | if rs > 0, then branch          |
| bltz rs, offset| 000001   | rs     | 00000  | offset|        |        | if rs < 0, then branch          |
| Jalr rd, rs    | 000000   | rs     | 00000  | Rd    | 00000  | 001001 | rd <- npc, PC <- rs             |
| mult rs, rt    | 000000   | rs     | rt     | 00000 | 00000  | 011000 | {hi, lo} <- rs * rt, signed     |
| multu rs, rt   | 000000   | rs     | rt     | 00000 | 00000  | 011001 | {hi, lo} <- rs * rt, unsigned   |
| div rs, rt     | 000000   | rs     | rt     | 00000 | 00000  | 011010 | {hi, lo} <- rs / rt, signed     |
| divu rs, rt    | 000000   | rs     | rt     | 00000 | 00000  | 011011 | {hi, lo} <- rs / rt, unsigned   |
| mfhi rd        | 000000   | 00000  | 00000  | Rd    | 00000  | 010000 | rd <- hi                        |
| mflo rd        | 000000   | 00000  | 00000  | Rd    | 00000  | 010010 | rd <- lo                        |
| mthi rs        | 000000   | rs     | 00000  | 00000 |        | 010001 | hi <- rs                        |
| mtlo rs        | 000000   | rs     | 00000  | 00000 |        | 010011 | lo <- rs                        |

### Table 3: MIPS 6 Exception Instructions

| 指令                | 31:26    | 25:21  | 20:16  | 15:11 | 10:6   | 5:0    | 功能                             |
|--------------------|----------|--------|--------|-------|--------|--------|----------------------------------|
| ll rt, offset(rs)  | 110000   | rs     | rt     | offset|        |        | load; LLbit=1                   |
| sc rt, offset(rs)  | 111000   | rs     | rt     | offset|        |        | if(LLbit) store; rt=1 else rt=0 |
| mfc0 rt, rd        | 010000   | 00000  | rt     | rd    | 00000  | 000000 | rt <- cp0[rd]                   |
| mtc0 rt, rd        | 010000   | 00100  | rt     | rd    | 00000  | 000000 | cp0[rd] <- rt                   |
| eret               | 010000   | 10000  | 00000  | 00000 | 00000  | 011000 | PC <- epc, LLbit <- 0          |
| syscall            | 000000   | 00000  | 00000  | 0     |        | 001100 | SysInt, LLbit <- 0             |

## TODO

- 约束文件；
- 开发板思路；
- 架构；
- 实现的功能：分支预测+缓存；
- 数码管显示+LCD。数码管显示 PC，LCD + 按钮用于人机交互，类似于终端；
- 简单的操作系统：不实现任何文件、内存管理，只借助于最简单的 UART 来打印一些字符；

## 问题

以后要考虑做流水线，又因为利用 vivado 提供的 ROM IP 是多周期访存的，如果利用这些 IP 做流水线，就极大地上升了难度。因此这里不打算使用 IP 核，所有的内存均由 Verilog 的 reg 类型模拟。

ROM 使用 2K，这意味着只能装一些小程序。最核心的也是唯一的系统调用 printf 只能自己实现然后链接到目标程序上。
RAM 使用 2K，RAM 基本用不到，足够了。

